---
title: "SEC Standards"
author: "Greg Bedwell"
date: "2/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/Documents/Lab/chromatography/standards/")
```

```{r}
library(ggrepel)
library(tidyverse)
```

#### Define the Bio Rad function
+ Define the function to:
  + Calculate the standard curve for the given column using:
    1. Bio Rad gel filtration standards
    2. A void volume analyte
    3. A column volume analyte
  + Predict unknown analyte masses and hydrodynamic radii based on the standard curve
  + Stokes radii for protein standards were estimated according to the equation for native proteins described in:
    + Uversky VN. Biochemistry. 32, 1993. 13288-13298

```{r}
sec <- function(void, cv, stds, masses = NULL, unk = NULL, plot = c("yes", "no"), type = c("cal", "pred")) {
  
  if(is.null(masses)){
    
    writeLines(c("No standard masses defined.",
                 "",
                 "Using Bio Rad standard masses as default.",
                 "",
                 "If these masses do not match your experiment, please define mass values.",
                 "Example: masses = c(value1, value2, etc.)"))
    
    stds <- data.frame(standards.ev = stds)
  
    void.vol = void
  
    col.vol = cv
  
    biorad.df <- data.frame(
    mw.da = c(669000,158000,44000,17000,1350)) %>%
      dplyr::mutate(rh.nm = (10^((-0.254+(0.369*log10(mw.da)))))/10)
  
    biorad.df <- cbind(biorad.df, stds)  %>%
      dplyr::mutate(ve.v0 = standards.ev - void.vol,
                    K.av = ve.v0/(max(col.vol)-void.vol))
  
    biorad.mw.fit <- lm(log(mw.da) ~ K.av, data = biorad.df)
  
    biorad.mw.r.sq <- data.frame(mw.r.sq = summary(biorad.mw.fit)$r.squared)
  
    biorad.rh.fit <- lm(log(rh.nm) ~ K.av, data= biorad.df)
  
    biorad.rh.r.sq <- data.frame(rh.r.sq = summary(biorad.rh.fit)$r.squared) }
  
  
  if(!is.null(masses)){
    
    writeLines(c("Using defined mass values instead of default values!",
                 ""))
    
    std.masses <- masses
    
    stds <- data.frame(standards.ev = stds)
  
    void.vol = void
  
    col.vol = cv
  
    biorad.df <- data.frame(
    mw.da = std.masses) %>%
      dplyr::mutate(rh.nm = (10^((-0.254+(0.369*log10(mw.da)))))/10)
  
    biorad.df <- cbind(biorad.df, stds)  %>%
      dplyr::mutate(ve.v0 = standards.ev - void.vol,
                    K.av = ve.v0/(max(col.vol)-void.vol))
  
    biorad.mw.fit <- lm(log(mw.da) ~ K.av, data = biorad.df)
  
    biorad.mw.r.sq <- data.frame(mw.r.sq = summary(biorad.mw.fit)$r.squared)
  
    biorad.rh.fit <- lm(log(rh.nm) ~ K.av, data= biorad.df)
  
    biorad.rh.r.sq <- data.frame(rh.r.sq = summary(biorad.rh.fit)$r.squared) }
  
  
  if(type == "cal" & plot == "no"){
    dat <- biorad.df %>% dplyr::select(K.av)
    
    mw.pred <- data.frame(predict(biorad.mw.fit, newdata = dat, interval = "confidence")) %>%
      dplyr::mutate(mw.pred = exp(fit),
                    mw.lwr = exp(lwr),
                    mw.upr = exp(upr),
                    type = "mw") %>%
      dplyr::select(mw.pred, mw.lwr, mw.upr)
    
    rh.pred <- data.frame(predict(biorad.rh.fit, newdata = dat, interval = "confidence")) %>%
      dplyr::mutate(rh.pred = exp(fit),
                    rh.lwr = exp(lwr),
                    rh.upr = exp(upr),
                    type = "rh") %>%
      dplyr::select(rh.pred, rh.lwr, rh.upr)
    
    biorad.df <- cbind(biorad.df, mw.pred, rh.pred, biorad.mw.r.sq, biorad.rh.r.sq)
    
    
    return(biorad.df) }
  
  
  if(type == "cal" & plot == "yes"){
    biorad.df <- biorad.df %>% 
      tidyr::pivot_longer(cols = c(mw.da, rh.nm), names_to = "sample") %>%
      dplyr::select(sample, value, K.av) %>%
      magrittr::set_colnames(c("sample","calc.value","K.av")) %>%
      dplyr::mutate(parameter = case_when(
        sample == "mw.da"~"mw",
        sample == "rh.nm"~"rh")) %>%
     dplyr::select(-c(sample)) %>%
     dplyr::arrange(parameter) %>%
     dplyr::select(parameter, K.av, calc.value)
  
    dat.mw <- biorad.df %>%
      dplyr::filter(parameter == "mw") %>%
      dplyr::select(K.av)
    
    dat.rh <- biorad.df %>%
      dplyr::filter(parameter == "rh") %>%
      dplyr::select(K.av)
    
    mw.pred <- data.frame(predict(biorad.mw.fit, newdata = dat.mw, interval = "confidence")) %>%
      dplyr::mutate(pred.value = exp(fit),
                    lwr = exp(lwr),
                    upr = exp(upr)) %>%
      dplyr::select(pred.value, lwr, upr)
  
    rh.pred <- data.frame(predict(biorad.rh.fit, newdata = dat.rh, interval = "confidence")) %>%
      dplyr::mutate(pred.value = exp(fit),
                    lwr = exp(lwr),
                    upr = exp(upr),
                    parameter = "rh") %>%
      dplyr::select(pred.value, lwr, upr)
  
   pred.combine <- rbind(mw.pred, rh.pred)
  
   biorad.df <- cbind(biorad.df, pred.combine)
  
    plot <- ggplot(biorad.df, aes(x=K.av, y=log(calc.value), fill=parameter)) +
      geom_point(shape=21, size=3, color="black") +
      geom_line(aes(x=K.av, y=log(pred.value), color=parameter), size=0.8) +
      geom_line(aes(x=K.av, y=log(lwr)), color = "black", size=0.2, linetype = "dashed") +
      geom_line(aes(x=K.av, y=log(upr)), color = "black", size=0.2, linetype = "dashed") +
      scale_fill_manual(values = c("darkblue","darkred"),
                        labels = c(expression(M[W]~(Da)), expression(R[H]~(nm))),
                        guide = guide_legend(title.position = "top",
                                             nrow = 1,
                                             title.hjust=0.5)) +
     scale_color_manual(values = c("darkblue","darkred")) +
      guides(color = FALSE) +
      theme_bw() +
      theme(axis.text=element_text(size=14),
           axis.title=element_text(size=16),
           legend.position = "top",
           legend.text = element_text(size=12),
           legend.title=element_blank(),
           legend.justification="center") +
      scale_y_continuous(name = expression(log(M[W]~(Da))), limits=c(-1, 15),
                        sec.axis = sec_axis(trans=~., name=expression(log(R[H]~(nm))))) +
      scale_x_continuous(limits=c(0,1),
                         breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1)) +
      xlab(expression(K[av]))
    
  
  
    return(plot) }
  
  
  if(type == "pred" & is.null(unk)){
    print("Must define analyte elution volumes!") }
  
  
  else{
    
    if(plot == "no"){
      
      pred.ev = data.frame(pred.ev = unk)
    
      biorad.pred <- pred.ev %>%
       dplyr::mutate(ve.v0 = pred.ev - void.vol,
                      K.av = ve.v0/(max(col.vol)-void.vol))
    
      dat <- biorad.pred %>% dplyr::select(K.av)
    
      mw.pred <- data.frame(predict(biorad.mw.fit, newdata = dat, interval = "confidence")) %>%
        dplyr::mutate(mw.pred = exp(fit),
                      mw.lwr = exp(lwr),
                      mw.upr = exp(upr)) %>%
        dplyr::select(mw.pred, mw.lwr, mw.upr)
    
      rh.pred <- data.frame(predict(biorad.rh.fit, newdata = dat, interval = "confidence")) %>%
        dplyr::mutate(rh.pred = exp(fit),
                      rh.lwr = exp(lwr),
                      rh.upr = exp(upr)) %>%
        dplyr::select(rh.pred, rh.lwr, rh.upr)
      
      biorad.pred <- cbind(biorad.pred, mw.pred, rh.pred)
      
      return(biorad.pred) }
    
    
    if(plot == "yes"){
      
      writeLines(c("Molecular weight and radius LABELS appearing on the plot on NOT log-transformed!",
                   "",
                   "NOTE THAT THE ACTUAL POINTS ARE STILL AT LOG-TRANSFORMED POSITIONS!",
                   "",
                   "Molecular weight LABELS are reported in kDa units.",
                   "Hydrodynamic radius LABELS are reported in nm units."))
      
      biorad.df <- biorad.df %>% 
        tidyr::pivot_longer(cols = c(mw.da, rh.nm), names_to = "sample") %>%
        dplyr::select(sample, value, K.av) %>%
        magrittr::set_colnames(c("sample","calc.value","K.av")) %>%
        dplyr::mutate(parameter = case_when(
          sample == "mw.da"~"mw",
          sample == "rh.nm"~"rh")) %>%
        dplyr::select(-c(sample)) %>%
        dplyr::arrange(parameter) %>%
        dplyr::select(parameter, K.av, calc.value)
  
      dat.mw <- biorad.df %>%
        dplyr::filter(parameter == "mw") %>%
        dplyr::select(K.av)
    
      dat.rh <- biorad.df %>%
        dplyr::filter(parameter == "rh") %>%
        dplyr::select(K.av)
    
      mw.std.pred <- data.frame(predict(biorad.mw.fit, newdata = dat.mw, interval = "confidence")) %>%
        dplyr::mutate(pred.value = exp(fit),
                      lwr = exp(lwr),
                      upr = exp(upr)) %>%
        dplyr::select(pred.value, lwr, upr)
      
      rh.std.pred <- data.frame(predict(biorad.rh.fit, newdata = dat.rh, interval = "confidence")) %>%
        dplyr::mutate(pred.value = exp(fit),
                      lwr = exp(lwr),
                      upr = exp(upr),
                      parameter = "rh") %>%
        dplyr::select(pred.value, lwr, upr)
      
      pred.combine <- rbind(mw.std.pred, rh.std.pred)
      
      biorad.df <- cbind(biorad.df, pred.combine)
  

      pred.ev = data.frame(pred.ev = unk)
    
      biorad.pred <- pred.ev %>%
       dplyr::mutate(ve.v0 = pred.ev - void.vol,
                      K.av = ve.v0/(max(col.vol)-void.vol))
    
      dat <- biorad.pred %>% dplyr::select(K.av)
    
      mw.pred <- data.frame(predict(biorad.mw.fit, newdata = dat, interval = "confidence")) %>%
        dplyr::mutate(mw.pred = exp(fit),
                      mw.lwr = exp(lwr),
                      mw.upr = exp(upr)) %>%
        dplyr::select(mw.pred, mw.lwr, mw.upr)
    
      rh.pred <- data.frame(predict(biorad.rh.fit, newdata = dat, interval = "confidence")) %>%
        dplyr::mutate(rh.pred = exp(fit),
                      rh.lwr = exp(lwr),
                      rh.upr = exp(upr),
                      parameter = "unknown") %>%
        dplyr::select(rh.pred, rh.lwr, rh.upr, parameter)
      
      biorad.pred <- cbind(biorad.pred, mw.pred, rh.pred)

   
    plot <- ggplot(biorad.df, aes(x=K.av, y=log(calc.value), fill=parameter)) +
      geom_point(shape=21, size=3, color="black") +
      geom_line(aes(x=K.av, y=log(pred.value), color=parameter), size=0.8) +
      geom_line(aes(x=K.av, y=log(lwr)), color = "black", size=0.2, linetype = "dashed") +
      geom_line(aes(x=K.av, y=log(upr)), color = "black", size=0.2, linetype = "dashed") +
      geom_point(data=biorad.pred, aes(x=K.av, y=log(mw.pred)), shape=21, size=3, color="black") +
      geom_point(data=biorad.pred, aes(x=K.av, y=log(rh.pred)), shape=21, size=3, color="black") +
      geom_label_repel(data=biorad.pred, 
                        aes(x=K.av, y=log(mw.pred), label=round(mw.pred/1000,2)), 
                        point.padding = 0.2,
                        nudge_y = 0.125,
                        color = "black",
                       fill="white") +
      geom_label_repel(data=biorad.pred, 
                        aes(x=K.av, y=log(rh.pred), label=round(rh.pred,2)), 
                        point.padding = 0.2,
                        nudge_y = 0.125,
                        color = "black",
                       fill="white") +
      scale_fill_manual(values = c("darkblue","darkred","darkgreen"),
                        labels = c(expression(M[W]~(Da)), expression(R[H]~(nm)), expression(Unknown)),
                        guide = guide_legend(title.position = "top",
                                             nrow = 1,
                                             title.hjust=0.5)) +
      scale_color_manual(values = c("darkblue","darkred","darkgreen")) +
      guides(color = FALSE) +
      theme_bw() +
      theme(axis.text=element_text(size=14),
           axis.title=element_text(size=16),
           legend.position = "top",
           legend.text = element_text(size=12),
           legend.title=element_blank(),
           legend.justification="center") +
      scale_y_continuous(name = expression(log(M[W]~(Da))), limits=c(-1, 15),
                        sec.axis = sec_axis(trans=~., name=expression(log(R[H]~(nm))))) +
      scale_x_continuous(limits=c(0,1),
                         breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1)) +
      xlab(expression(K[av]))
  
  
    return(plot) } } }

```


```{r}
sec(masses = NULL,
       void = 1.87, 
       cv = 4.29, 
       stds = c(2.08,2.58,2.98,3.30,4.06), 
       unk = NULL, 
       plot = "no",
       type = "cal")


sec(masses = NULL,
       void = 1.87, 
       cv = 4.29, 
       stds = c(2.08,2.58,2.98,3.30,4.06), 
       unk = NULL, 
       plot = "yes",
       type = "cal")


sec(masses = c(669000, 158000, 44000, 17000, 1350), 
       void = 1.87, 
       cv = 4.29, 
       stds = c(2.08,2.58,2.98,3.30,4.06), 
       unk = NULL, 
       plot = "no",
       type = "cal")


sec(masses = c(669000, 158000, 44000, 17000, 1350), 
       void = 1.87, 
       cv = 4.29, 
       stds = c(2.08,2.58,2.98,3.30,4.06), 
       unk = NULL, 
       plot = "yes",
       type = "cal")


sec(masses = c(669000, 158000, 44000, 17000, 1350), 
       void = 1.87, 
       cv = 4.29, 
       stds = c(2.08,2.58,2.98,3.30,4.06), 
       unk = c(2.11, 2.49, 3.28, 3.87), 
       plot = "no",
       type = "pred")


sec(masses = c(669000, 158000, 44000, 17000, 1350), 
       void = 1.87, 
       cv = 4.29, 
       stds = c(2.08,2.58,2.98,3.30,4.06), 
       unk = c(2.11, 2.49, 3.28, 3.87), 
       plot = "yes",
       type = "pred")
```


#### BCA
```{r}
bca <- function(prot.conc, blank.abs, std.abs, abs = NULL, dil.fac = NULL, plot = c("yes", "no"), type = c("cal", "pred")) {
  bca.df <- data.frame(conc = prot.conc,
                    abs = std.abs) %>%
    dplyr::mutate(corr.abs = abs - blank.abs)
  
  bca.std.fit <- lm(conc ~ corr.abs, data = bca.df)
  
  bca.std.r.sq <- data.frame(r.sq = summary(bca.std.fit)$r.squared)
  
  
  if(type == "cal" & plot == "no"){
    dat <- bca.df %>% dplyr::select(corr.abs)
    
    conc.pred <- data.frame(predict(bca.std.fit, newdata = dat, interval = "confidence")) %>%
      dplyr::mutate(conc.pred = fit,
                    conc.lwr = lwr,
                    conc.upr = upr) %>%
      dplyr::select(conc.pred, conc.lwr, conc.upr)
    
    bca.df <- cbind(bca.df, conc.pred, bca.std.r.sq)
    
    
    return(bca.df) }
  
  
  if(type == "cal" & plot == "yes"){
    dat <- bca.df %>% dplyr::select(corr.abs)
  
    conc.pred <- data.frame(predict(bca.std.fit, newdata = dat, interval = "confidence")) %>%
      dplyr::mutate(conc.pred = fit,
                    conc.lwr = lwr,
                    conc.upr = upr) %>%
      dplyr::select(conc.pred, conc.lwr, conc.upr)
    
    bca.df <- cbind(bca.df, conc.pred, bca.std.r.sq)
    
    plot <- ggplot(bca.df, aes(x=corr.abs, y=conc)) +
      geom_point(fill = "darkblue", shape=21, size=3, color="black") +
      geom_line(aes(x=corr.abs, y=conc.pred), color="darkblue", size=0.8) +
      geom_line(aes(x=corr.abs, y=conc.lwr), color = "black", size=0.2, linetype = "dashed") +
      geom_line(aes(x=corr.abs, y=conc.upr), color = "black", size=0.2, linetype = "dashed") +
      guides(color = FALSE,
             fill = FALSE) +
      theme_bw() +
      theme(axis.text=element_text(size=14),
            axis.title=element_text(size=16),
            legend.position = "top",
            legend.text = element_text(size=12),
            legend.title=element_blank(),
            legend.justification="center") +
      labs(x = "Corrected Absorbance", y = "Protein Concentration (mg/mL)")
      
    
    
    return(plot) }
  
  
  
  if(type == "pred" & (is.null(abs) | is.null(dil.fac))){
    
    writeLines(c("Must define both unknown analyte absorbance values and dilution factors!",
                 "",
                 "Dilution factors must be defined for every unknown analyte!")) }
  
  else{
    
    if(plot == "no") {
      
      bca.pred = data.frame(unk.abs = abs,
                            df = dil.fac) %>%
        dplyr::mutate(corr.abs = unk.abs - blank.abs)
      
      
      dat <- bca.pred %>% dplyr::select(corr.abs)
      
      conc.pred <- data.frame(predict(bca.std.fit, newdata = dat, interval = "confidence")) %>%
        dplyr::mutate(conc.pred = fit,
                      conc.lwr = lwr,
                      conc.upr = upr) %>%
        dplyr::select(conc.pred, conc.lwr, conc.upr)
      
      bca.pred <- cbind(bca.pred, conc.pred) %>%
        dplyr::mutate(conc.pred.corr = conc.pred*df,
                      conc.lwr.corr = conc.lwr*df,
                      conc.upr.corr = conc.upr*df)
      
      return(bca.pred) }
    
    
    if(plot == "yes"){
      
      writeLines(c("The concentrations reported as labels on the plot are the DF CORRECTED values!",
                   "",
                   "These represent the final values that should usually be used in downstream calculations!",
                   "",
                   "For multiple dilutions of the same sample, the mean of these values should be calculated.",
                   "",
                   "Corrected concentrations are still reported in mg/mL units."))
      
      dat.std <- bca.df %>% dplyr::select(corr.abs)
  
      std.pred <- data.frame(predict(bca.std.fit, newdata = dat.std, interval = "confidence")) %>%
        dplyr::mutate(std.pred = fit,
                      std.lwr = lwr,
                      std.upr = upr) %>%
        dplyr::select(std.pred, std.lwr, std.upr)
      
      bca.df <- cbind(bca.df, std.pred, bca.std.r.sq)
      
      
      bca.pred = data.frame(unk.abs = abs,
                            df = dil.fac) %>%
        dplyr::mutate(corr.abs = unk.abs - blank.abs)
      
      
      dat <- bca.pred %>% dplyr::select(corr.abs)
      
      conc.pred <- data.frame(predict(bca.std.fit, newdata = dat, interval = "confidence")) %>%
        dplyr::mutate(conc.pred = fit,
                      conc.lwr = lwr,
                      conc.upr = upr) %>%
        dplyr::select(conc.pred, conc.lwr, conc.upr)
      
      bca.pred <- cbind(bca.pred, conc.pred) %>%
        dplyr::mutate(conc.pred.corr = conc.pred*df,
                      conc.lwr.corr = conc.lwr*df,
                      conc.upr.corr = conc.upr*df)
      
      
      plot <- ggplot(bca.df, aes(x=corr.abs, y=conc)) +
        geom_point(fill = "darkblue", shape=21, size=3, color="black") +
        geom_line(aes(x=corr.abs, y=std.pred), color="darkblue", size=0.8) +
        geom_line(aes(x=corr.abs, y=std.lwr), color = "black", size=0.2, linetype = "dashed") +
        geom_line(aes(x=corr.abs, y=std.upr), color = "black", size=0.2, linetype = "dashed") +
        geom_point(data=bca.pred, aes(x=corr.abs, y=conc.pred), shape=21, size=3, fill = "darkgreen", color="black") +
        geom_label_repel(data=bca.pred, 
                        aes(x=corr.abs, y=conc.pred, label=round(conc.pred.corr,2)), 
                        point.padding = 0.1,
                        nudge_y = 0.125,
                        color = "black") +
        guides(color = FALSE,
               fill = FALSE) +
        theme_bw() +
        theme(axis.text=element_text(size=14),
              axis.title=element_text(size=16),
              legend.position = "top",
              legend.text = element_text(size=12),
              legend.title=element_blank(),
              legend.justification="center") +
        labs(x = "Corrected Absorbance", y = "Protein Concentration (mg/mL)")
  
  
    return(plot) } } }

```



```{r}
bca(prot.conc = c(2, 1.5, 1, 0.75, 0.5, 0.25, 0.125, 0.025),
    blank.abs = 0.1813,
    std.abs = c(2.4644, 1.989, 1.4295, 1.1075, 0.8124, 0.499, 0.3655, 0.2315),
    abs = NULL,
    plot = "no",
    type = "cal")


bca(prot.conc = c(2, 1.5, 1, 0.75, 0.5, 0.25, 0.125, 0.025),
    blank.abs = 0.1813,
    std.abs = c(2.4644, 1.989, 1.4295, 1.1075, 0.8124, 0.499, 0.3655, 0.2315),
    abs = NULL,
    plot = "yes",
    type = "cal")


bca(prot.conc = c(2, 1.5, 1, 0.75, 0.5, 0.25, 0.125, 0.025),
    blank.abs = 0.1813,
    std.abs = c(2.4644, 1.989, 1.4295, 1.1075, 0.8124, 0.499, 0.3655, 0.2315),
    abs = c(2.0184, 1.1641, 0.5831),
    dil.fac = c(5, 10, 20),
    plot = "no",
    type = "pred")


bca(prot.conc = c(2, 1.5, 1, 0.75, 0.5, 0.25, 0.125, 0.025),
    blank.abs = 0.1813,
    std.abs = c(2.4644, 1.989, 1.4295, 1.1075, 0.8124, 0.499, 0.3655, 0.2315),
    abs = c(2.0184, 1.1641, 0.5831),
    dil.fac = c(5, 10, 20),
    plot = "yes",
    type = "pred")
```



#### UV/Vis concentrations
```{r}
uv.vis <- function(type = c("protein","dsDNA","ssDNA","ssRNA"), 
                   A260, A280, dil.fac, path.length = NULL, extinction.coeff = NULL, mol.weight = NULL){
  
  if(is.null(path.length)){
    
    path = 1
    
    writeLines(c("----------------------------------------------------------------------------------------------",
                 "Assuming path length is 1 cm!",
                 "",
                 "If your path length differs from 1 cm, enter the correct value as 'path.length' in CENTIMETERS",
                 "-----------------------------------------------------------------------------------------------",
                 "")) }
  
  if(!is.null(path.length)){
    
    path = path.length }
    
    
    
  
      if(type == "protein"){ 
        
        writeLines(c("--------------------------------------------------------",
                     "Please enter extinction coefficient values in MOLAR units!",
                     "",
                     "Please enter protein molecular weight in GRAMS/MOLE!",
                     "--------------------------------------------------------",
                     ""))
        
        if(is.null(extinction.coeff)) {
        
          writeLines(c("Must define protein extinction coefficient in MOLAR units!",
                       "",
                       "Use the function prot.param() in this package for estimation at 280 and 205 nm.",
                       "",
                       "The web tool https://web.expasy.org/protparam/ also provides this value at 280 nm.")) }
        
        if(is.null(mol.weight)){
            
            writeLines(c("This function assumes the extinction coefficient is reported in MOLAR units!",
                         "",
                         "Molecular weight is not supplied. Only molar concentration will be reported!"))
            
            dat <- data.frame(A280 = A280,
                              A260 = A260,
                              A280.A260.ratio = A280/A260,
                              df = dil.fac,
                              corr.A280 = A280*dil.fac,
                              path.len = path,
                              ext.coeff = extinction.coeff)
            
            dat <- dat %>%
              dplyr::mutate(molar.conc = (corr.A280/(extinction.coeff*path.len))*1000000) %>%
              dplyr::select(corr.A280, molar.conc, A280.A260.ratio) %>%
              tidyr::pivot_longer(everything(), names_to = "parameter", values_to = "value")
                              
            
            return(dat) }
          
          if(!is.null(mol.weight)){
            
            writeLines(c("This function assumes the extinction coefficient is reported in MOLAR units!",
                         "",
                         "Concentration will be reported in both molar and mass (mg/mL) units!"))
            
            dat <- data.frame(A280 = A280,
                              A260 = A260,
                              A280.A260.ratio = A280/A260,
                              df = dil.fac,
                              corr.A280 = A280*dil.fac,
                              path.len = path,
                              ext.coeff = extinction.coeff)
                               
            
            dat <- dat %>%
              dplyr::mutate(molar.conc = (corr.A280/(extinction.coeff*path.len))*1000000,
                            mass.conc = (molar.conc/1000000)*mol.weight) %>%
              dplyr::select(corr.A280, molar.conc, mass.conc, A280.A260.ratio) %>%
              tidyr::pivot_longer(everything(), names_to = "parameter", values_to = "value")
            
            return(dat) } }
      
      
      if(type == "dsDNA"){
        
        writeLines(c("Calculating concentration of dsDNA!"))
        
        dat <- data.frame(A280 = A280,
                          A260 = A260,
                          A260.A280.ratio = A260/A280,
                          df = dil.fac,
                          corr.A260 = A260*dil.fac,
                          path.len = path)
            
            dat <- dat %>%
              dplyr::mutate(ug.mL = corr.A260*df*path.len*50) %>%
              dplyr::select(corr.A260, ug.mL, A260.A280.ratio) %>%
              tidyr::pivot_longer(everything(), names_to = "parameter", values_to = "value")
                              
            
            return(dat) }
      
      if(type == "ssDNA"){
        
        writeLines(c("Calculating concentration of ssDNA!"))
        
        dat <- data.frame(A280 = A280,
                          A260 = A260,
                          A260.A280.ratio = A260/A280,
                          df = dil.fac,
                          corr.A260 = A260*dil.fac,
                          path.len = path)
            
            dat <- dat %>%
              dplyr::mutate(ug.mL = corr.A260*df*path.len*33) %>%
              dplyr::select(corr.A260, ug.mL, A260.A280.ratio) %>%
              tidyr::pivot_longer(everything(), names_to = "parameter", values_to = "value")
                              
            
            return(dat) }
      
      if(type == "ssRNA"){
        
        writeLines(c("Calculating concentration of ssRNA!"))
        
        dat <- data.frame(A280 = A280,
                          A260 = A260,
                          A260.A280.ratio = A260/A280,
                          df = dil.fac,
                          corr.A260 = A260*dil.fac,
                          path.len = path)
            
            dat <- dat %>%
              dplyr::mutate(ug.mL = corr.A260*df*path.len*40) %>%
              dplyr::select(corr.A260, ug.mL, A260.A280.ratio) %>%
              tidyr::pivot_longer(everything(), names_to = "parameter", values_to = "value") }
                              
            
            return(dat) }

```


```{r}
uv.vis(type = "protein",
       A260 = 0.1356,
       A280 = 0.2441,
       dil.fac = 20,
       path.length = NULL,
       extinction.coeff = 34192,
       mol.weight = 28624)


uv.vis(type = "protein",
       A260 = 0.1356,
       A280 = 0.2441,
       dil.fac = 20,
       path.length = NULL,
       extinction.coeff = 34192,
       mol.weight = NULL)

uv.vis(type = "dsDNA",
       A260 = 0.2441,
       A280 = 0.1356,
       dil.fac = 1,
       path.length = 1)

uv.vis(type = "ssDNA",
       A260 = 0.2441,
       A280 = 0.1356,
       dil.fac = 1,
       path.length = 1)


uv.vis(type = "ssRNA",
       A260 = 0.2441,
       A280 = 0.1356,
       dil.fac = 1,
       path.length = 1)

```


#### Protein parameters

```{r}
prot.param <- function(aa.sequence, temp){
  
  aa.str <- c("A","R","N","D","C","Q","E","G","H","I","L","K","M","F","P","S","T","W","Y","V")
  
  aa.dat <- data.frame(amino.acid = c("A","R","N","D","C","E","Q","G","H","I","L","K","M","F","P","S","T","W","Y","V"),
                       mono.mass = c(71.03711381,156.1011111,114.0429275,115.0269431,103.0091845,129.0425931,128.0585775,
                                     57.02146374,137.0589119,113.084064,113.084064,128.0949631,131.0404846,147.0684139,
                                     97.05276388,87.03202844,101.0476785,186.079313,163.0633286,99.06841395),
                       avg.mass = c(71.0779,156.18568,114.10264,115.0874,103.1429,129.11398,128.12922,57.05132,
                                    137.13928,113.15764,113.15764,128.17228,131.19606,147.17386,97.11518,
                                    87.0773,101.10388,186.2099,163.17326,99.13106),
                       vbar = c(0.74,0.70,0.62,0.60,0.63,0.67,0.66,0.64,0.67,0.90,
                                0.90,0.82,0.75,0.77,0.76,0.63,0.70,0.74,0.71,0.86),
                       ext.h2o = c(0,0,0,0,125,0,0,0,0,0,0,0,0,0,0,0,0,5500,1490,0),
                       ext.guhcl = c(0,0,0,0,120,0,0,0,0,0,0,0,0,0,0,0,0,5690,1280,0),
                       ext.205 = c(0,1350,400,0,690,0,400,0,5200,0,0,0,0,8600,0,0,0,20400,6080,0))
  
  aa.count <- data.frame(amino.acid = aa.str,
                         aa.count = stringr::str_count(aa.sequence, aa.str))
  
  aa.dat <- dplyr::inner_join(aa.dat, aa.count, by="amino.acid")
  
  residues <- aa.dat %>%
    dplyr::summarise(value = sum(aa.count)) %>%
    dplyr::mutate(parameter = "number of residues")
  
  avg.mass <- aa.dat %>%
    dplyr::summarise(value = sum(aa.count*avg.mass),
                     value = value+18) %>%
    dplyr::mutate(parameter = "isotopically averaged mass (Da)")
  
  mono.mass <- aa.dat %>%
    dplyr::summarise(value = sum(aa.count*mono.mass),
                     value = value+18,
                     ) %>%
    dplyr::mutate(parameter = "monoisotopic mass (Da)")
  
  vbar.25 <- aa.dat %>%
    dplyr::mutate(parameter = "vbar at 25C (mL/g)") %>%
    dplyr::mutate(value = (sum(aa.count*(avg.mass)*vbar))/(sum(aa.count*(avg.mass)))) %>%
    dplyr::select(parameter, value) %>%
    dplyr::distinct()
  
  vbar.temp <- aa.dat %>%
    dplyr::mutate(parameter = "vbar at temp (mL/g)") %>%
    dplyr::mutate(vbar.25 = (sum(aa.count*(avg.mass)*vbar))/(sum(aa.count*(avg.mass))),
                  value = vbar.25 + (0.000425*((temp+273.15)-298.15))) %>%
    dplyr::select(parameter, value) %>%
    dplyr::distinct()
  
  ext.coeff <- aa.dat %>%
    dplyr::summarise(value = sum(aa.count*ext.h2o)) %>%
    dplyr::mutate(parameter = "folded molar ext. coeff. at 280 nm (OD/mol*cm) in H2O")
  
  ext.coeff.guhcl <- aa.dat %>%
    dplyr::summarise(value = sum(aa.count*ext.guhcl)) %>%
    dplyr::mutate(parameter = "unfolded molar ext. coeff. at 280 nm (OD/mol*cm) in 6 M GuHCl")
  
  ext.205 <- aa.dat %>%
    dplyr::summarise(value = sum(aa.count*ext.205) + 2780*(sum(aa.count)-1)) %>%
    dplyr::mutate(parameter = "molar ext. coeff. at 205 nm (OD/mol*cm) in water")
  
  combo <- rbind(residues, avg.mass, mono.mass, vbar.25, vbar.temp, ext.coeff, ext.205) %>%
    dplyr::select(parameter, value)
  
  r.sphere <- data.frame(parameter = "radius of sphere with equal mass and density (nm)",
                         value = (((3*(combo[2,2])*(combo[5,2]))/(4*pi*6.022E+23))^(1/3))*10^7)
  
  
  r.denat <- data.frame(parameter = "denatured radius (nm)",
                        value = (2.21*(combo[1,2])^0.57)/10)
  
  
  r.glob <- data.frame(parameter = "globular radius (nm)",
                       value = (4.75*(combo[1,2])^0.29)/10)
    
  
  combo <- rbind(residues, avg.mass, mono.mass, vbar.temp,
                 ext.coeff, ext.coeff.guhcl, ext.205, r.sphere, r.denat, r.glob) %>%
    dplyr::select(parameter, value) %>%
    dplyr::mutate_if(is.numeric, round, 3)
  
  
  
  return(combo)
  
}

```


```{r}
protein <- c("MKWVTFISLLLLFSSAYSRGVFRRDTHKSEIAHRFKDLGEEHFKGLVLIAFSQYLQQCPF
DEHVKLVNELTEFAKTCVADESHAGCEKSLHTLFGDELCKVASLRETYGDMADCCEKQEP
ERNECFLSHKDDSPDLPKLKPDPNTLCDEFKADEKKFWGKYLYEIARRHPYFYAPELLYY
ANKYNGVFQECCQAEDKGACLLPKIETMREKVLTSSARQRLRCASIQKFGERALKAWSVA
RLSQKFPKAEFVEVTKLVTDLTKVHKECCHGDLLECADDRADLAKYICDNQDTISSKLKE
CCDKPLLEKSHCIAEVEKDAIPENLPPLTADFAEDKDVCKNYQEAKDAFLGSFLYEYSRR
HPEYAVSVLLRLAKEYEATLEECCAKDDPHACYSTVFDKLKHLVDEPQNLIKQNCDQFEK
LGEYGFQNALIVRYTRKVPQVSTPTLVEVSRSLGKVGTRCCTKPESERMPCTEDYLSLIL
NRLCVLHEKTPVSEKVTKCCTESLVNRRPCFSALTPDETYVPKAFDEKLFTFHADICTLP
DTEKQIKKQTALVELLKHKPKATEEQLKTVMENFVAFVDKCCAADDKEACFAVEGPKLVV
STQTALA")

prot.param(protein, temp=25)

```


#### Dilution calculator
```{r}
dilution.calc <- function(samples, final.vol, final.conc, starting.conc, combine=c("yes","no")){
  
  if(combine == "no"){
    
  dat <- data.frame(species = samples)
  
  dat <- dat %>%
    dplyr::mutate(vol.sample = (final.vol*final.conc)/starting.conc,
                  vol.buffer = final.vol - vol.sample) }
  
  if(combine == "yes"){
    
  dat <- data.frame(species = samples)
  
  dat <- dat %>%
    dplyr::mutate(vol.sample = (final.vol*final.conc)/starting.conc,
                  vol.buffer = final.vol - sum(vol.sample)) }
  
  return(dat) }


```

```{r}
dilution.calc(samples = c("sample1","Sample2","Sample3"),
              final.vol = c(20,10,50),
              final.conc = c(25,5,10),
              starting.conc = c(100,50,40),
              combine="no")


dilution.calc(samples = c("sample1","Sample2"),
              final.vol = c(100, 100),
              final.conc = c(100,50),
              starting.conc = c(284.23,169.79),
              combine="yes")

```

#### Calculating masses of chemical to add to solution
```{r}
chem.mass <- function(chemicals, mass, final.conc, final.vol){
  
  dat <- data.frame(chemical = chemicals)
  
  dat <- dat %>%
    dplyr::mutate(g.to.add = mass*final.conc*final.vol,
                  mg.to.add = mass*final.conc*final.vol*1000,
                  final.volume.L = final.vol,
                  final.vol.mL = final.vol*1000)
  
  return(dat) }

```


```{r}
chem.mass(chem=c("NaCl","Imidazole"),
          mass = c(58.44, 68.08),
          final.conc = c(0.150, 0.500),
          final.vol = c(0.5, 0.5))

```


#### Gibson assembly reaction set-up
```{r}
gibson <- function(sample.list, vector.list, insert.conc, insert.len, vec.conc, vec.len, molar.ratio, final.vol, vec.mass=NULL){

  if(is.null(vec.mass)){
    
    writeLines(c("--------------------------------------------------------",
                 "Assuming the desired vector mass is 50 ng",
                 "--------------------------------------------------------",
                 ""))
    
    dat <- data.frame(sample = sample.list,
                      vector = vector.list)
  
    dat <- dat %>%
      dplyr::mutate(pmol.vec = (50*1000)/(vec.len*650),
                    vol.vec = 50/vec.conc,
                    pmol.insert = pmol.vec*molar.ratio,
                    mass.insert = (pmol.insert*(insert.len*650))/1000,
                    vol.insert = mass.insert/insert.conc,
                    vol.water = final.vol - (vol.vec+vol.insert),
                    vol.mix = final.vol) %>%
      dplyr::select(sample, vector, vol.vec, vol.insert, vol.water, vol.mix)
    
    return(dat) }
    
  else{
    dat <- data.frame(sample = sample.list,
                      vector = vector.list)
  
    dat <- dat %>%
      dplyr::mutate(pmol.vec = (vec.mass*1000)/(vec.len*650),
                    vol.vec = vec.mass/vec.conc,
                    pmol.insert = pmol.vec*molar.ratio,
                    mass.insert = (pmol.insert*(insert.len*650))/1000,
                    vol.insert = mass.insert/insert.conc,
                    vol.water = final.vol - (vol.vec+vol.insert),
                    vol.mix = final.vol) %>%
      dplyr::select(sample, vector, vol.vec, vol.insert, vol.water, vol.mix) 
    
    return(dat) } } 


```


```{r}
gibson(sample.list = c("EFP operon"),
       vector.list = c("pGB9"),
       insert.conc = 315,
       insert.len = 2700,
       vec.conc = 10.6,
       vec.len = 5500,
       vec.mass = 50,
       molar.ratio = 3,
       final.vol = 5)

gibson(sample.list = c("EFP operon"),
       vector.list = c("pGB9"),
       insert.conc = 315,
       insert.len = 2700,
       vec.conc = 10.6,
       vec.len = 5500,
       vec.mass = NULL,
       molar.ratio = 3,
       final.vol = 5)


gibson(sample.list = c("EFP operon", "EFP operon"),
       vector.list = c("pGB9-F6", "pGB9"),
       insert.conc = c(315, 315),
       insert.len = c(2700, 2700),
       vec.conc = c(14.5,12.4),
       vec.len = c(7500,5500),
       vec.mass = 50,
       molar.ratio = 3,
       final.vol = 5)

```




















